<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>MareFrame DB querying library — mfdb-package • mfdb</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="MareFrame DB querying library — mfdb-package"><meta property="og:description" content="Tools to query a MareFrame DB and reformat results in forms
    useful for GADGET and EwE models."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mfdb</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">7.3-99</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/import_hydrography_cmems.html">Import hydrographic data into MFDB</a>
    </li>
    <li>
      <a href="../articles/population.html">Storing &amp; grouping by arbitrary populations</a>
    </li>
    <li>
      <a href="../articles/tow_data.html">Storing &amp; grouping by tow metadata</a>
    </li>
    <li>
      <a href="../articles/trip.html">Storing &amp; grouping by vessel trips</a>
    </li>
    <li>
      <a href="../articles/weightmeasurements.html">Storing &amp; grouping other weight measurements</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"></ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>MareFrame DB querying library</h1>
    
    <div class="hidden name"><code>mfdb-package.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Tools to query a MareFrame DB and reformat results in forms
    useful for GADGET and EwE models.</p>
    </div>


    <div id="introduction-amp-schema-description">
    <h2>Introduction &amp; Schema description</h2>
    <p>Before doing anything with <span class="pkg">mfdb</span>, it is worth knowing a bit about how data
is stored. Broadly, there are 2 basic types of table in <span class="pkg">mfdb</span>,
<em>taxonomy</em> and <em>measurement</em> tables.</p>
<p>The measurement tables store all forms of sample data supported, at the finest
available detail. These are then aggregated when using any of the mfdb query
functions. All measurement data is separated by case study, so multiple case
studies can be loaded into a database without conflicts.</p>
<p>Taxonomy tables store all possible values for terms and their meaning, to
ensure consistency in the data. For example, <samp>species</samp> stores short-names
and full latin names of all known species to MFDB, to ensure consistency in naming.</p>
<p>Most Taxonomies have defaults which are populated when the database is created,
and their definitions are stored as data attached to this package. See <a href="mfdb-data.html">mfdb-data</a> for more
information on these. Others, such as <samp>areacell</samp> and <samp>sampling_type</samp> are
case study specific, and you will need to define your terms before you can
import data.</p>
    </div>
    <div id="importing-data">
    <h2>Importing data</h2>
    <p>Unless you are working with a remote database, you will need to populate the
database at least once before you are able to do any querying. The steps your
script needs to do are:</p>
<div class="section">
<h3 id="connect-to-database">Connect to database<a class="anchor" aria-label="anchor" href="#connect-to-database"></a></h3>
<p>Use the <a href="mfdb.html">mfdb</a>() function. This will create tables / populate taxonomies if necessary.</p>
</div>

<div class="section">
<h3 id="define-areas-amp-divisions">Define areas &amp; divisions<a class="anchor" aria-label="anchor" href="#define-areas-amp-divisions"></a></h3>
<p><span class="pkg">mfdb</span> models space in the following way:</p><dl><dt>areacell</dt>
<dd><p>The finest level of detail stored in the database. Every measurement (e.g.
    temperature, length sample) is assigned to an areacell. This will generally
    correspond to ICES gridcells, however there is no requirement to do so. You
    might augment gridcell information with depth, or include divisions when the
    measurement doesn't correlate to a specific areacell.</p></dd>

  <dt>division</dt>
<dd><p>Collections of areacells, e.g. ICES subdivisions, or whatever is appropriate.</p></dd>


</dl><p>Finally, when querying, divisions are grouped together into named collections,
for instance <code>mfdb_group(north = 1:3, south = 4:6)</code> will put anything in
divisions 1--3 under an area named "north", 4--5 under an area named "south".</p>
<p>Before you can upload any measurements, you have to define the areacells
that they will use. You do this using the <a href="mfdb_import_taxonomy.html">mfdb_import_area</a>() function. This
allows you to import tables of area/division information, such as:</p>
<p><code>
mfdb_import_area(mdb, data.frame(
    area = c('101', '102', '103', '401','402', '403'),
    division = c('1', '1', '1', '4', '4', '4'),
    ))
</code></p>
<p>If you want areas to be part of multiple divisions, then you can use
<a href="mfdb_import_taxonomy.html">mfdb_import_division</a>() to import extra revisions.</p>
</div>

<div class="section">
<h3 id="define-sampling-types">Define sampling types<a class="anchor" aria-label="anchor" href="#define-sampling-types"></a></h3>
<p>Any survey data can have a sampling type defined, which then can be used when
querying data. If you want to use a sampling type, then define it using
<a href="mfdb_import_taxonomy.html">mfdb_import_sampling_type</a>().</p>
</div>

<div class="section">
<h3 id="import-temperature-data">Import temperature data<a class="anchor" aria-label="anchor" href="#import-temperature-data"></a></h3>
<p>At this point, you can start uploading actual measurements. The easiest of
which is temperature. Upload a table of areacell/month/temperature data
using <a href="mfdb_import_data.html">mfdb_import_temperature</a>().</p>
</div>

<div class="section">
<h3 id="import-survey-data">Import survey data<a class="anchor" aria-label="anchor" href="#import-survey-data"></a></h3>
<p>Finally, import any survey data using <a href="mfdb_import_data.html">mfdb_import_survey</a>(). Ideally
upload your data in separate chunks. For example, if you have length and
age-length data, don't combine them in R, upload them separately and both
will be used when querying for length data. This keeps the process simple,
and allows you to swap out data as necessary.</p>
</div>

<div class="section">
<h3 id="import-stomach-survey">Import stomach survey<a class="anchor" aria-label="anchor" href="#import-stomach-survey"></a></h3>
<p>Stomach surveys are imported in much the same way, however there are 2 data.frames,
one representing predators, one preys. The column <samp>stomach_name</samp> links the
two, which can contain any numeric / character value, as long as it is unique
for predators and prey measurements are assigned to the correct stomach.</p>
</div>

<p>See <a href="mfdb_import_data.html">mfdb_import_survey</a> for more information or 
<a href="../demo">the demo directory</a> for concrete examples.</p>
<div class="section">
<h3 id="dumping-restoring-a-db">Dumping / Restoring a DB<a class="anchor" aria-label="anchor" href="#dumping-restoring-a-db"></a></h3>
<p>You can also dump/import a dump from another host using the postgres pg_dump
and pg_restore commands. You can dump/restore indvidual schemas (i.e. the 
case study you give to the mfdb() command), to list all the schemas installed
run <code>SELECT DISTINCT(table_schema) FROM information_schema.tables</code> from
psql. Note that if you use <code>mfdb('Baltic')</code>, the Postgres schema name will
be lower-cased.</p>
<p>Create a dump of your chosen schema with the following command:</p>
<div class="sourceCode"><pre><code>
pg_dump --schema=baltic -Fc mf &gt; baltic.dump
</code></pre></div>

<p>This will make a dump of the "baltic" case study into "baltic.tar". It can
then be restored onto another computer with the following:</p>
<div class="sourceCode"><pre><code>
pg_restore --clean -d mf baltic.dump
</code></pre></div>

<p>If you already have a baltic schema you wish to preserve, you can rename it
first by issuing <code>ALTER SCHEMA baltic RENAME TO baltic_o</code> in psql. Once
the restore is done you can rename the new schema and put the name of the old
schema back.</p>
</div>


    </div>
    <div id="querying-data">
    <h2>Querying data</h2>
    <p>There are a selection of querying functions available, all of which work
same way. You give a set of parameters, each of which can be a vector of
data you wish returned, for instance <code>year = 1998:2000</code> or
<code>species = c('COD')</code>.</p>
<p>If also grouping by this column (i.e. 'year', 'timestep', 'area' and any
other columns given, e.g. 'age'), then the parameter will control how this
grouping works, e.g. <code>maturity_stage = mfdb_group(imm = 1, mat = 2:5)</code>
will result in the maturity_stage column having either 'imm' or 'mat'.
These will also be used to generate GADGET aggregation files later.</p>
<p>For example, the following queries the temperature table:</p>
<div class="sourceCode"><pre><code><span></span>
<span><span class="va">defaults</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    area <span class="op">=</span> <span class="fu"><a href="../reference/mfdb_aggregate_group.html">mfdb_group</a></span><span class="op">(</span><span class="st">"101"</span> <span class="op">=</span> <span class="op">)</span>,</span>
<span>    timestep <span class="op">=</span> <span class="va">mfdb_timestep_quarterly</span>, <span class="co"># Group months to create 2 timesteps for each year</span></span>
<span>    year <span class="op">=</span> <span class="fl">1996</span><span class="op">:</span><span class="fl">2005</span><span class="op">)</span></span>
<span><span class="va">agg_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mfdb_queries.html">mfdb_temperature</a></span><span class="op">(</span><span class="va">mdb</span>, <span class="va">defaults</span><span class="op">)</span></span></code></pre></div>

<p>All functions will result in a list of data.frame result tables (generally
only one, unless you requested bootstrapping). Each are suitable for
feeding into a gadget function to output into model files.</p>
<p>See <a href="mfdb_queries.html">mfdb_sample_count</a> for more information or 
<a href="../demo">the demo directory</a> for concrete examples.</p>
    </div>
    <div id="creating-gadget-files">
    <h2>Creating GADGET files</h2>
    <p>Finally, there are a set of functions that turn the output of queries into
GADGET model files. These work on a <a href="gadget_directory.html">gadget_directory</a> object, which
can either be an existing GADGET model to alter, or an empty / nonexistant
directory.</p>
<p>Generally, the result of an mfdb query will be enough to create a
corresponding GADGET file, for instance, the following will create a GADGET
area file in your gadget directory:</p>
<div class="sourceCode"><pre><code><span></span>
<span><span class="fu"><a href="../reference/gadget_directory.html">gadget_dir_write</a></span><span class="op">(</span><span class="va">gd</span>,<span class="fu"><a href="../reference/gadget_areafile.html">gadget_areafile</a></span><span class="op">(</span></span>
<span>    size <span class="op">=</span> <span class="fu"><a href="../reference/mfdb_queries.html">mfdb_area_size</a></span><span class="op">(</span><span class="va">mdb</span>, <span class="va">defaults</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    temperature <span class="op">=</span> <span class="fu"><a href="../reference/mfdb_queries.html">mfdb_temperature</a></span><span class="op">(</span><span class="va">mdb</span>, <span class="va">defaults</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>

<p>See <a href="gadget_areafile.html">gadget_areafile</a> or <a href="gadget_likelihood_component.html">gadget_likelihood_component</a> for more
information or <a href="../demo">the demo directory</a> for concrete examples.</p>
<div class="section">
<h3 id="stock-and-fleet-files">Stock and fleet files<a class="anchor" aria-label="anchor" href="#stock-and-fleet-files"></a></h3>
<p>Stocks and fleets aren't explicitly defined in the database. Instead, they are
definied by querying on a column that differentiates them. For example, if
your "immature cod" stock is definied as cod that is between maturity stages 1
and 2, then if querying for a stockdistribution component, one could do:</p>
<div class="sourceCode"><pre><code>
    mfdb_sample_count(mdb, c('maturity_stage', 'age', 'length'), list(
        species = 'COD',
        maturity_stage = c(imm = 1:2, mat = 3:5),
        . . .
    )
</code></pre></div>

<p>...and the maturity_stage column will be treated as the stock.</p>
</div>


    </div>
    <div id="acknowledgements">
    <h2>Acknowledgements</h2>
    <p>This project has received funding from the European Union's Seventh Framework
Programme for research, technological development and demonstration under grant
agreement no.613571.</p>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Jamie Lentin</p>
<p>Maintainer: Jamie Lentin &lt;jamie.lentin@shuttlethread.com&gt;</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><a href="https://github.com/gadget-framework/rgadget" class="external-link">rgadget</a>,
<a href="https://gadget-framework.github.io/gadget2/userguide/" class="external-link">Gadget user guide</a></p></div>
    </div>

  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Jamie Lentin, Bjarki Thor Elvarsson.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer></div>

  


  

  </body></html>

