<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Storing &amp; grouping by vessel trips • mfdb</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Storing &amp; grouping by vessel trips">
<meta property="og:description" content="mfdb">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mfdb</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">7.0-99</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/import_hydrography_cmems.html">Import hydrographic data into MFDB</a>
    </li>
    <li>
      <a href="../articles/population.html">Storing &amp; grouping by arbitrary populations</a>
    </li>
    <li>
      <a href="../articles/tow_data.html">Storing &amp; grouping by tow metadata</a>
    </li>
    <li>
      <a href="../articles/trip.html">Storing &amp; grouping by vessel trips</a>
    </li>
    <li>
      <a href="../articles/weightmeasurements.html">Storing &amp; grouping other weight measurements</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="trip_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Storing &amp; grouping by vessel trips</h1>
            
      
      
      <div class="hidden name"><code>trip.Rmd</code></div>

    </div>

    
    
<p>Samples can be assigned to a <em>trip</em>, which provides a way of including socioeconomic data into MFDB.</p>
<p>The following examples use the following table_string helper to succintly define tables:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Convert a string into a data.frame</span>
<span class="va">table_string</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">text</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span>
    text <span class="op">=</span> <span class="va">text</span>,
    blank.lines.skip <span class="op">=</span> <span class="cn">TRUE</span>,
    header <span class="op">=</span> <span class="cn">TRUE</span>,
    stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span>,
    <span class="va">...</span><span class="op">)</span></code></pre></div>
<p>Then connect to a database and set up some areas/divisions:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mfdb.html">mfdb</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">'.duckdb'</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="../reference/mfdb_import_taxonomy.html">mfdb_import_area</a></span><span class="op">(</span><span class="va">mdb</span>, <span class="fu">table_string</span><span class="op">(</span><span class="st">'
name  division size
45G01     divA   10
45G02     divA  200
45G03     divB  400
'</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div id="importing-data" class="section level2">
<h2 class="hasAnchor">
<a href="#importing-data" class="anchor"></a>Importing data</h2>
<p>Trips can have a <em>start_port</em> and <em>end_port</em> associated with them, before we can do this we need to define any ports we use. We do this with <code>mfdb_import_port_taxonomy</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mfdb_import_taxonomy.html">mfdb_import_port_taxonomy</a></span><span class="op">(</span><span class="va">mdb</span>, <span class="fu">table_string</span><span class="op">(</span><span class="st">'
name    description     institute   latitude longitude
ISHFF   Hafnarfjordur   ISL         64.04   21.57
NOHVJ   Hvalfjordur     ISL         64.21   21.45
ISKEF   Keflavik    ISL         64.00   22.33
ISREK   Reykjavik   ISL         64.09   21.55
ISSEJ   Seydisfjordur   ISL         65.15   13.55
ISKJF   Skerjafjordur   ISL         64.07   21.54
'</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We can now define trips that use these ports:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mfdb_import_taxonomy.html">mfdb_import_trip_taxonomy</a></span><span class="op">(</span><span class="va">mdb</span>, <span class="fu">table_string</span><span class="op">(</span><span class="st">'
name    start_date  end_date    crew    oil_consumption start_port  end_port
T1  2019-01-21  2019-02-11  4   3000        ISKEF       ISREK
T2  2019-01-24  2019-02-14  5   9000        ISKEF       ISSEJ
T3  2019-04-21  2019-05-11  4   3000        ISREK       ISKEF
T4  2019-04-24  2019-05-14  5   9000        ISSEJ       ISKEF
'</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>There is no formal link between trips and tows, so you can link a sample to a tow without recording trips. But we can create tows and vessels to use:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mfdb_import_taxonomy.html">mfdb_import_tow_taxonomy</a></span><span class="op">(</span><span class="va">mdb</span>, <span class="fu">table_string</span><span class="op">(</span><span class="st">'
name latitude longitude  depth length
 T1a     64.1    -23.15  98.82     10
 T1b     64.1    -23.15  98.82     10
 T2a     64.1    -23.15  98.82     10
 T2b     64.1    -23.15  98.82     10
 T3a     64.1    -23.15  98.82     10
 T3b     64.1    -23.15  98.82     10
 T4a     64.1    -23.15  98.82     10
 T4b     64.1    -23.15  98.82     10
'</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mfdb_import_taxonomy.html">mfdb_import_vessel_taxonomy</a></span><span class="op">(</span><span class="va">mdb</span>, <span class="fu">table_string</span><span class="op">(</span><span class="st">'
name full_name
V1  "Vessel 1"
V2  "Vessel 2"
'</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>And finally import data that is associated to a vessel/trip/tow:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mfdb_import_data.html">mfdb_import_survey</a></span><span class="op">(</span><span class="va">mdb</span>, data_source <span class="op">=</span> <span class="st">"cod2000"</span>,
<span class="fu">table_string</span><span class="op">(</span><span class="st">[1654 chars quoted with '"']</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="querying-data" class="section level2">
<h2 class="hasAnchor">
<a href="#querying-data" class="anchor"></a>Querying data</h2>
<p>We can now use the <code>mfdb_sample_*</code> functions to select this data back out again.</p>
<p>We can group and filter by any of the trip attributes. For instance, to group/filter by <code>trip_start_date</code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">agg_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mfdb_queries.html">mfdb_sample_count</a></span><span class="op">(</span><span class="va">mdb</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'trip_start_date'</span>, <span class="st">'length'</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    trip_start_date <span class="op">=</span> <span class="st">'2019-01-21'</span>,
    length <span class="op">=</span> <span class="fu"><a href="../reference/mfdb_aggregate_unaggregated.html">mfdb_unaggregated</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">agg_data</span></code></pre></div>
<pre><code>## $`0.0.0.0.0`
##   year step area trip_start_date length number
## 1  all  all  all      2019-01-21     10    598
## 2  all  all  all      2019-01-21     20    598
## 3  all  all  all      2019-01-21     30    284</code></pre>
<p>Note that we’ve summed T1a and T1b, since their start date matches.</p>
<p>We can use <code>mfdb_group</code>() to aggregate several ports, for instance:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">agg_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mfdb_queries.html">mfdb_sample_count</a></span><span class="op">(</span><span class="va">mdb</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'trip_start_port'</span>, <span class="st">'length'</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    trip_start_port <span class="op">=</span> <span class="fu"><a href="../reference/mfdb_aggregate_group.html">mfdb_group</a></span><span class="op">(</span>KEF <span class="op">=</span> <span class="st">'ISKEF'</span>, other <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ISREK'</span>, <span class="st">'ISSEJ'</span><span class="op">)</span><span class="op">)</span>,
    length <span class="op">=</span> <span class="fu"><a href="../reference/mfdb_aggregate_unaggregated.html">mfdb_unaggregated</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">agg_data</span></code></pre></div>
<pre><code>## $`0.0.0.0.0`
##   year step area trip_start_port length number
## 1  all  all  all             KEF     10   1202
## 2  all  all  all             KEF     20    842
## 3  all  all  all             KEF     30    714
## 4  all  all  all           other     10   1372
## 5  all  all  all           other     20   1023
## 6  all  all  all           other     30    925</code></pre>
<p>We can also use <code>mfdb_dplyr_sample</code> to re-extract data, joining with port metadata:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mfdb_dplyr.html">mfdb_dplyr_sample</a></span><span class="op">(</span><span class="va">mdb</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'trip_start_port'</span>, <span class="st">'trip_end_port'</span>, <span class="st">'trip_start_port_latitude'</span><span class="op">)</span><span class="op">)</span> |&gt;
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">'year'</span>, <span class="st">'month'</span>, <span class="st">'trip_start_port'</span>, <span class="st">'trip_end_port'</span>, <span class="st">'trip_start_port_latitude'</span>, <span class="st">'count'</span><span class="op">)</span> |&gt;
    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>##    year month trip_start_port trip_end_port trip_start_port_latitude count
## 1  2019     1           ISKEF         ISREK                    64.00   358
## 2  2019     1           ISKEF         ISREK                    64.00   320
## 3  2019     1           ISKEF         ISREK                    64.00   162
## 4  2019     1           ISKEF         ISREK                    64.00   240
## 5  2019     1           ISKEF         ISREK                    64.00   278
## 6  2019     1           ISKEF         ISREK                    64.00   122
## 7  2019     2           ISKEF         ISSEJ                    64.00   255
## 8  2019     2           ISKEF         ISSEJ                    64.00   138
## 9  2019     2           ISKEF         ISSEJ                    64.00   168
## 10 2019     2           ISKEF         ISSEJ                    64.00   349
## 11 2019     2           ISKEF         ISSEJ                    64.00   106
## 12 2019     2           ISKEF         ISSEJ                    64.00   262
## 13 2019     4           ISREK         ISKEF                    64.09   395
## 14 2019     4           ISREK         ISKEF                    64.09   214
## 15 2019     4           ISREK         ISKEF                    64.09   195
## 16 2019     4           ISREK         ISKEF                    64.09   396
## 17 2019     4           ISREK         ISKEF                    64.09   325
## 18 2019     4           ISREK         ISKEF                    64.09   269
## 19 2019     5           ISSEJ         ISKEF                    65.15   239
## 20 2019     5           ISSEJ         ISKEF                    65.15   309
## 21 2019     5           ISSEJ         ISKEF                    65.15   162
## 22 2019     5           ISSEJ         ISKEF                    65.15   342
## 23 2019     5           ISSEJ         ISKEF                    65.15   175
## 24 2019     5           ISSEJ         ISKEF                    65.15   299</code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mfdb.html">mfdb_disconnect</a></span><span class="op">(</span><span class="va">mdb</span><span class="op">)</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jamie Lentin, Bjarki Thor Elvarsson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
