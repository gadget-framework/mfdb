<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Import hydrographic data into MFDB â€¢ mfdb</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Import hydrographic data into MFDB">
<meta property="og:description" content="mfdb">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mfdb</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">7.2-99</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/import_hydrography_cmems.html">Import hydrographic data into MFDB</a>
    </li>
    <li>
      <a href="../articles/population.html">Storing &amp; grouping by arbitrary populations</a>
    </li>
    <li>
      <a href="../articles/tow_data.html">Storing &amp; grouping by tow metadata</a>
    </li>
    <li>
      <a href="../articles/trip.html">Storing &amp; grouping by vessel trips</a>
    </li>
    <li>
      <a href="../articles/weightmeasurements.html">Storing &amp; grouping other weight measurements</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="import_hydrography_cmems_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Import hydrographic data into MFDB</h1>
            
      
      
      <div class="hidden name"><code>import_hydrography_cmems.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mfdb</span><span class="op">)</span></code></pre></div>
<p>Hydrographic products are available from numerous sources. Here, we provide a working example where outputs from a hydrographic model are:</p>
<ul>
<li>downloaded from Copernicus Marine Service <a href="https://marine.copernicus.eu/" class="external-link uri">https://marine.copernicus.eu/</a>
</li>
<li>aggregated over ICES rectangles</li>
<li>imported into MFDB</li>
</ul>
<div class="section level1">
<h1 id="download-monthly-hydrographic-data">Download monthly hydrographic data<a class="anchor" aria-label="anchor" href="#download-monthly-hydrographic-data"></a>
</h1>
<p>CMEMS Baltic Sea Physical Reanalysis product provides a physical reanalysis for the whole Baltic Sea area from January 1993 and up to minus 1-1.5 year compared to real time. The product is produced by using the ice-ocean model NEMO-Nordic (based on NEMO-3.6, Nucleus for European Modelling of the Ocean) together with a LSEIK data assimilation scheme, <a href="https://resources.marine.copernicus.eu/?option=com_csw&amp;view=details&amp;product_id=BALTICSEA_REANALYSIS_PHY_003_011" class="external-link uri">https://resources.marine.copernicus.eu/?option=com_csw&amp;view=details&amp;product_id=BALTICSEA_REANALYSIS_PHY_003_011</a>. As a demonstration we retrieve one year of already processed monthly means of bottom temperature (bottomT), but hydrographic products are also available for separate depth layers and at higher spatiotemporal resolution, and can be aggregated before import according to the needs. Note that an account has to be created to download data from Copernicus Marine Service using the script below.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">RCMEMS</span><span class="op">)</span>

<span class="co"># point to the data product</span>
<span class="va">cfg</span> <span class="op">&lt;-</span> <span class="fu">CMEMS.config</span><span class="op">(</span>motu<span class="op">=</span><span class="st">"http://my.cmems-du.eu/motu-web/Motu"</span>,
                         service.id <span class="op">=</span> <span class="st">"BALTICSEA_REANALYSIS_PHY_003_011-TDS"</span>,
                         product.id <span class="op">=</span> <span class="st">"dataset-reanalysis-nemo-monthlymeans"</span>,
                         variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bottomT"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># add user and psw</span>
<span class="va">CMEMS.config.usr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"username"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/scan.html" class="external-link">scan</a></span><span class="op">(</span><span class="st">""</span>, what<span class="op">=</span><span class="st">"character"</span>, nmax<span class="op">=</span><span class="fl">1</span>, quiet<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
    <span class="op">}</span>
<span class="va">CMEMS.config.pwd</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"password"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/scan.html" class="external-link">scan</a></span><span class="op">(</span><span class="st">""</span>, what<span class="op">=</span><span class="st">"character"</span>, nmax<span class="op">=</span><span class="fl">1</span>, quiet<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
    <span class="op">}</span>
<span class="va">cfg</span><span class="op">@</span><span class="va">user</span> <span class="op">&lt;-</span> <span class="fu">CMEMS.config.usr</span><span class="op">(</span><span class="op">)</span>
<span class="va">cfg</span><span class="op">@</span><span class="va">pwd</span>  <span class="op">&lt;-</span> <span class="fu">CMEMS.config.pwd</span><span class="op">(</span><span class="op">)</span>

<span class="co"># select year and download</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">2018</span> <span class="co"># year of interest</span>
<span class="fu">CMEMS.download</span><span class="op">(</span><span class="va">cfg</span>,
                   ROI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">17</span>,<span class="fl">20</span>,<span class="fl">56</span>,<span class="fl">58.5</span><span class="op">)</span>,
                   date.range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ISOdatetime.html" class="external-link">ISOdate</a></span><span class="op">(</span><span class="va">y</span>,<span class="fl">01</span>,<span class="fl">01</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/ISOdatetime.html" class="external-link">ISOdate</a></span><span class="op">(</span><span class="va">y</span>,<span class="fl">12</span>,<span class="fl">31</span><span class="op">)</span><span class="op">)</span>,
                   depth.range<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">500</span><span class="op">)</span>, <span class="co"># max depth Baltic 459 m</span>
                   out.path<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"data_provided/CMEMS_BAL_PHY_reanalysis_monthlymeans_"</span>,<span class="va">y</span>,<span class="st">".nc"</span>,sep<span class="op">=</span><span class="st">""</span><span class="op">)</span>,
               debug<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level1">
<h1 id="download-ices-rectangles">Download ICES rectangles<a class="anchor" aria-label="anchor" href="#download-ices-rectangles"></a>
</h1>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span>url<span class="op">=</span><span class="st">"https://gis.ices.dk/shapefiles/ICES_StatRec_mapto_ICES_Areas.zip"</span>, <span class="va">temp</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/unzip.html" class="external-link">unzip</a></span><span class="op">(</span><span class="va">temp</span>, exdir<span class="op">=</span><span class="st">"data_provided/ices_rect"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level1">
<h1 id="aggregate-hydrographic-data-by-ices-rectangles">Aggregate hydrographic data by ICES rectangles<a class="anchor" aria-label="anchor" href="#aggregate-hydrographic-data-by-ices-rectangles"></a>
</h1>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster" class="external-link">raster</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ropenscilabs/rnaturalearth" class="external-link">rnaturalearth</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/lwgeom/" class="external-link">lwgeom</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>

<span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">2018</span> <span class="co"># year of interest</span>

<span class="co"># load ICES rect</span>
<span class="va">ices.rect</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">"data_provided/ices_rect/StatRec_map_Areas_Full_20170124.dbf"</span>, quiet <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>

<span class="co"># load bottom temperature (bottomT)</span>
<span class="va">rst</span> <span class="op">&lt;-</span> <span class="fu">brick</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"data_provided/CMEMS_BAL_PHY_reanalysis_monthlymeans_"</span>,<span class="va">y</span>,<span class="st">".nc"</span>,sep<span class="op">=</span><span class="st">""</span><span class="op">)</span>, varname<span class="op">=</span><span class="st">"bottomT"</span>, lvar<span class="op">=</span><span class="fl">4</span><span class="op">)</span>

<span class="co"># calculate mean sob (raster) by ices rect (polygons)</span>
<span class="va">ov</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu">extract</span><span class="op">(</span><span class="va">rst</span>,<span class="va">ices.rect</span>, fun<span class="op">=</span><span class="va">mean</span>, na.rm<span class="op">=</span><span class="cn">T</span>, df<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
<span class="va">hydroVar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>ID<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ices.rect</span><span class="op">$</span><span class="va">ICESNAME</span><span class="op">)</span>,
                       rect<span class="op">=</span><span class="va">ices.rect</span><span class="op">$</span><span class="va">ICESNAME</span>,
                       areaFull_km2<span class="op">=</span><span class="va">ices.rect</span><span class="op">$</span><span class="va">AREA_KM2</span>,
                       year<span class="op">=</span><span class="va">y</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">right_join</span><span class="op">(</span><span class="va">ov</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">gather</span><span class="op">(</span><span class="st">"month"</span>,<span class="st">"sob"</span>,<span class="fl">4</span><span class="op">:</span><span class="fl">15</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substring</a></span><span class="op">(</span><span class="va">month</span>,<span class="fl">7</span>,<span class="fl">8</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">sob</span><span class="op">)</span><span class="op">)</span> <span class="co"># NA are on land or outside the raster area</span>

<span class="va">land</span> <span class="op">&lt;-</span> <span class="fu">rnaturalearth</span><span class="fu">::</span><span class="fu">ne_countries</span><span class="op">(</span>returnclass <span class="op">=</span> <span class="st">"sf"</span>, continent<span class="op">=</span><span class="st">"Europe"</span>, scale<span class="op">=</span><span class="st">"large"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">st_union</span><span class="op">(</span><span class="op">)</span>
<span class="va">ices.rect.sea</span> <span class="op">&lt;-</span> <span class="va">ices.rect</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ICESNAME</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">hydroVar</span><span class="op">$</span><span class="va">rect</span><span class="op">)</span> <span class="op">%&gt;%</span>
         <span class="fu">st_difference</span><span class="op">(</span><span class="va">land</span><span class="op">)</span>
<span class="va">ices.rect.sea</span><span class="op">$</span><span class="va">areaSea_km2</span> <span class="op">&lt;-</span> <span class="fu">st_area</span><span class="op">(</span><span class="va">ices.rect.sea</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">units</span><span class="fu">::</span><span class="fu">set_units</span><span class="op">(</span><span class="va">km</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>

<span class="va">hydroVar</span> <span class="op">&lt;-</span> <span class="va">ices.rect.sea</span> <span class="op">%&gt;%</span>
    <span class="fu">rename</span><span class="op">(</span>rect<span class="op">=</span><span class="va">ICESNAME</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">select</span><span class="op">(</span><span class="va">rect</span>, <span class="va">areaSea_km2</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">right_join</span><span class="op">(</span><span class="va">hydroVar</span><span class="op">)</span>

<span class="fu">ggplot</span><span class="op">(</span><span class="va">hydroVar</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="fu">st_geometry</span><span class="op">(</span><span class="va">ices.rect.sea</span><span class="op">)</span>, fill<span class="op">=</span><span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu">xmin</span><span class="op">(</span><span class="fu">extent</span><span class="op">(</span><span class="va">hydroVar</span><span class="op">)</span><span class="op">)</span>, <span class="fu">xmax</span><span class="op">(</span><span class="fu">extent</span><span class="op">(</span><span class="va">hydroVar</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu">ymin</span><span class="op">(</span><span class="fu">extent</span><span class="op">(</span><span class="va">hydroVar</span><span class="op">)</span><span class="op">)</span>, <span class="fu">ymax</span><span class="op">(</span><span class="fu">extent</span><span class="op">(</span><span class="va">hydroVar</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span>  

<span class="co"># Write the results to temporary files so we can read them back in the next step</span>

<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu">st_drop_geometry</span><span class="op">(</span><span class="va">ices.rect.sea</span><span class="op">)</span>, file <span class="op">=</span> <span class="st">'ices.rect.sea.txt'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu">st_drop_geometry</span><span class="op">(</span><span class="va">hydroVar</span><span class="op">)</span>, file <span class="op">=</span> <span class="st">'hydroVar.txt'</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level1">
<h1 id="import-bottom-temperature-into-mfdb">Import bottom temperature into mfdb<a class="anchor" aria-label="anchor" href="#import-bottom-temperature-into-mfdb"></a>
</h1>
<p>Import ICES rectangles and import the hydrographic data as a survey index. Then we can retrieve the hydrographic data as a weighted mean using ICES rectangle as a weighting variable:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mfdb.html">mfdb</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">'.duckdb'</span><span class="op">)</span><span class="op">)</span>

<span class="va">ices.rect.sea</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="st">'ices.rect.sea.txt'</span><span class="op">)</span>
<span class="va">hydroVar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="st">'hydroVar.txt'</span><span class="op">)</span>

<span class="co"># import ICES rectangles</span>
<span class="fu"><a href="../reference/mfdb_import_taxonomy.html">mfdb_import_area</a></span><span class="op">(</span><span class="va">mdb</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>
    name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">ices.rect.sea</span><span class="op">$</span><span class="va">ICESNAME</span><span class="op">)</span>,
    size <span class="op">=</span> <span class="va">ices.rect.sea</span><span class="op">$</span><span class="va">areaSea_km2</span><span class="op">)</span><span class="op">)</span>

<span class="co"># import area size as index for later use</span>
<span class="fu"><a href="../reference/mfdb_import_taxonomy.html">mfdb_import_cs_taxonomy</a></span><span class="op">(</span><span class="va">mdb</span>, <span class="st">"index_type"</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>name<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ices_rect"</span>, <span class="st">"bottom_temp"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="../reference/mfdb_import_data.html">mfdb_import_survey_index</a></span><span class="op">(</span><span class="va">mdb</span>,
                         data_source<span class="op">=</span><span class="st">"area_ices_rect"</span>,
                         <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>index_type <span class="op">=</span> <span class="st">"ices_rect"</span>,
                                        year       <span class="op">=</span> <span class="va">hydroVar</span><span class="op">$</span><span class="va">year</span>,
                                        month      <span class="op">=</span> <span class="va">hydroVar</span><span class="op">$</span><span class="va">month</span>,
                                        areacell   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">hydroVar</span><span class="op">$</span><span class="va">rect</span><span class="op">)</span>,
                                        value      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">hydroVar</span><span class="op">$</span><span class="va">areaSea_km2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># import avg bottom temperature by month and ICES rect (under the 'length' field)</span>
<span class="fu"><a href="../reference/mfdb_import_data.html">mfdb_import_survey_index</a></span><span class="op">(</span><span class="va">mdb</span>,
                   data_source<span class="op">=</span><span class="st">"bottom_temp_CMEMS"</span>,
                   <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>year       <span class="op">=</span> <span class="va">hydroVar</span><span class="op">$</span><span class="va">year</span>,
                              month      <span class="op">=</span> <span class="va">hydroVar</span><span class="op">$</span><span class="va">month</span>,
                              areacell   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">hydroVar</span><span class="op">$</span><span class="va">rect</span><span class="op">)</span>,
                              value     <span class="op">=</span> <span class="va">hydroVar</span><span class="op">$</span><span class="va">sob</span>,
                              index_type <span class="op">=</span> <span class="st">"bottom_temp"</span>,
                              stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>

<span class="co"># extract mean bottom temperature by quarter and area (weighted mean using rectangle area)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mfdb_queries.html">mfdb_survey_index_mean</a></span><span class="op">(</span><span class="va">mdb</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
                                       <span class="co">## area = mfdb_unaggregated(),</span>
                                       area <span class="op">=</span> <span class="fu"><a href="../reference/mfdb_aggregate_group.html">mfdb_group</a></span><span class="op">(</span><span class="st">'a1'</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'42G7'</span>,<span class="st">'42G8'</span>,<span class="st">'42G9'</span>,<span class="st">'43G7'</span>,<span class="st">'43G8'</span>,<span class="st">'43G9'</span><span class="op">)</span>,
                                                         <span class="st">'a2'</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'44G7'</span>,<span class="st">'44G8'</span>,<span class="st">'44G9'</span>,<span class="st">'45G7'</span>,<span class="st">'45G8'</span>,<span class="st">'45G9'</span><span class="op">)</span><span class="op">)</span>,
                                       timestep <span class="op">=</span> <span class="va">mfdb_timestep_quarterly</span>,
                                       year <span class="op">=</span> <span class="fl">2018</span>,
                                       index_type <span class="op">=</span> <span class="st">"bottom_temp"</span>,
                                       data_source <span class="op">=</span> <span class="st">'bottom_temp_CMEMS'</span><span class="op">)</span>,
                              scale_index <span class="op">=</span> <span class="st">'area_size'</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'year'</span>, <span class="st">'step'</span>, <span class="st">'area'</span>, <span class="st">'mean'</span><span class="op">)</span><span class="op">]</span>
<span class="va">dat</span></code></pre></div>
<pre><code><span class="co">##   year step area     mean</span>
<span class="co">## 1 2018    1   a1 5.130875</span>
<span class="co">## 2 2018    1   a2 5.285476</span>
<span class="co">## 3 2018    2   a1 5.772546</span>
<span class="co">## 4 2018    2   a2 5.787375</span>
<span class="co">## 5 2018    3   a1 7.258872</span>
<span class="co">## 6 2018    3   a2 6.609387</span>
<span class="co">## 7 2018    4   a1 6.143770</span>
<span class="co">## 8 2018    4   a2 6.019377</span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mfdb.html">mfdb_disconnect</a></span><span class="op">(</span><span class="va">mdb</span><span class="op">)</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jamie Lentin, Bjarki Thor Elvarsson.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
